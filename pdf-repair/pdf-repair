#!/bin/sh
# ---------------------------------------------------
# Repair broken PDF file using gs
#
# Depends on :
#   * ghostscript
#   * gvfs-bin
# Revision history :
#   08/11/2014, V1.0 - Creation by N. Bernaerts
# ---------------------------------------------------

# get original document
ORG_URI="$1"

# generate corrected document name
ORG_BASE=$(echo "$ORG_URI" | sed 's/^\(.*\)\..*$/\1/')
ORG_EXT=$(echo "$ORG_URI" | sed 's/^.*\.\(.*\)$/\1/')
NEW_URI="$ORG_BASE-repaired.$ORG_EXT"

# generate temporary local filename
ORG_TMP=$(mktemp -t XXXXXXXX.${ORG_EXT})
NEW_TMP=$(mktemp -t XXXXXXXX.${ORG_EXT})

# copy input file to temporary local file
gvfs-copy "${ORG_URI}" "${ORG_TMP}"

# generate corrected PDF
gs -q -dNOPAUSE -dBATCH -dSAFER -sDEVICE=pdfwrite -sOutputFile="${NEW_TMP}" "${ORG_TMP}"
# copy back corrected file
gvfs-copy "${NEW_TMP}" "${NEW_URI}"

# remove temporary local files
rm ${ORG_TMP}
rm ${NEW_TMP}
